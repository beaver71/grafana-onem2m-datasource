{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","ae","jsonData","origin","headers","basicAuth","length","options","query","buildQueryParameters","targets","filter","t","hide","when","data","qry","Math","max","maxDataPoints","console","log","cra","range","from","_d","crb","to","toISOString","replace","activeTargets","target","push","allQueryPromise","map","doRequest","method","_this","all","then","result","each","responseList","response","index","status","_respTable","field","path","_respTimeserie","series","serie","resp","message","title","p","Promise","resolve","reject","annotation","annotationQuery","datasource","enable","iconColor","rangeRaw","interpolated","arr","split","d","i","n","text","value","cols","k","_getContent","con","Date","getTime","datasourceRequest","scopedVars","refId","cin","cnf","indexOf","JSON","parse","e","warn","utc_str","utc","toDate","out","columns","row","_utc2date","ct","prop","rows","props","get","datapoints","dp"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\r\n\r\nimport moment from \"moment\";\r\n\r\nexport class GenericDatasource {\r\n\r\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n    this.type = instanceSettings.type;\r\n    this.url = instanceSettings.url;\r\n    this.name = instanceSettings.name;\r\n    this.q = $q;\r\n    this.backendSrv = backendSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.withCredentials = instanceSettings.withCredentials;\r\n    this.ae = instanceSettings.jsonData.ae;\r\n    this.origin = instanceSettings.jsonData.origin;\r\n    this.headers = {'Content-Type': 'application/json'};\r\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\r\n      this.headers['Authorization'] = instanceSettings.basicAuth;\r\n    }\r\n    if (this.origin) {\r\n      this.headers['X-M2M-Origin'] = this.origin;\r\n    }\r\n  }\r\n\r\n  query(options) {\r\n    var query = this.buildQueryParameters(options);\r\n    query.targets = query.targets.filter(t => !t.hide);\r\n\r\n    if (query.targets.length <= 0) {\r\n      return this.q.when({data: []});\r\n    }\r\n\r\n    //var qry = \"lim=\"+query.maxDataPoints;\r\n    var qry = \"rcn=5&lim=\"+Math.max(query.maxDataPoints, 10000);\r\n    console.log(\"query: \", query);\r\n\r\n    // \"2018-01-19T05:04:06.746Z\" ISOstring\r\n    var cra = query.range.from._d;\r\n    var crb = query.range.to._d;\r\n    cra = cra.toISOString().replace(/-/, '').replace(/-/, '').replace(/:/, '').replace(/:/, '').replace(/\\..+/, '');\r\n    crb = crb.toISOString().replace(/-/, '').replace(/-/, '').replace(/:/, '').replace(/:/, '').replace(/\\..+/, '');\r\n    console.log(\"cra, crb: \", cra, crb);\r\n    qry += \"&cra=\"+cra+\"&crb=\"+crb;\r\n\r\n    if (query.targets.length>1) {\r\n        /* Multi target */\r\n        \r\n        var activeTargets = [];\r\n        for (let target of query.targets) {\r\n            if (target.hide) {\r\n                continue;\r\n            }\r\n            activeTargets.push(target);\r\n        }\r\n        console.log(\"activeTargets: \", activeTargets);\r\n        \r\n        var url = this.url;\r\n        if (this.ae) url = url + '/' + this.ae;\r\n        var allQueryPromise = _.map(query.targets, target => {\r\n            return this.doRequest({\r\n              url: url + '/' + target.target + '?' + qry,\r\n              data: query,\r\n              method: 'GET'\r\n            });\r\n        });\r\n        var _this = this;\r\n        return this.q.all(allQueryPromise).then(responseList => {\r\n            var result = [];\r\n            _.each(responseList, (response, index) => {\r\n                if (response.status === 200) {\r\n                    if (response.data[\"m2m:cin\"] && response.data[\"m2m:cin\"].length>0) {\r\n                        var data = response.data[\"m2m:cin\"];\r\n                        if (activeTargets[index].type=='table') {\r\n                            console.log(index+\"-response: \", data, activeTargets[index].target);\r\n                            result.push(_this._respTable(data));\r\n                        } else if (activeTargets[index].type=='timeserie') {\r\n                            console.log(index+\"-response: \", data, activeTargets[index].target, activeTargets[index].field);\r\n                            if (activeTargets[index].field && activeTargets[index].field.path) {\r\n                                result.push(_this._respTimeserie(data, activeTargets[index].field)[0]);\r\n                            } else {\r\n                                var series = _this._respTimeserie(data);\r\n                                for (let serie of series) {\r\n                                    result.push(serie);\r\n                                }\r\n                            }\r\n                        }\r\n                    } else {\r\n                        result.push([]);\r\n                    }\r\n                } else {\r\n                    var resp = { status: \"error\", message: \"error\", title: \"error\" };\r\n                    result.push(resp);\r\n                }\r\n            });\r\n            console.log(\"ALL-response: \", result);\r\n            return {data: result};\r\n        });\r\n    } else {\r\n        /* mono target */\r\n        var _this = this;\r\n        var url = this.url;\r\n        if (this.ae) url = url + '/' + this.ae;\r\n        var p = new Promise(function(resolve, reject) {\r\n            _this.doRequest({\r\n              url: url + '/' + query.targets[0].target + '?' + qry,\r\n              data: query,\r\n              method: 'GET'\r\n            }).then(function (response) {\r\n              if (response.status === 200) {\r\n                    console.log(\"response: \", response.data);\r\n                    if (response.data[\"m2m:cin\"] && response.data[\"m2m:cin\"].length>0) {\r\n                        var data = response.data[\"m2m:cin\"];\r\n                        if (query.targets[0].type=='table') {\r\n                            resolve({ data: _this._respTable(data) });\r\n                        } else if (query.targets[0].type=='timeserie') {\r\n                            resolve({ data: _this._respTimeserie(data, query.targets[0].field) });\r\n                        }\r\n                    } else {\r\n                        resolve([]);\r\n                    }\r\n              } else {\r\n                    var resp = { status: \"error\", message: \"error\", title: \"error\" };\r\n                    reject(resp);\r\n              }\r\n            });\r\n        });\r\n        return p;\r\n    }\r\n\r\n  }\r\n\r\n  testDatasource() {\r\n    var url = this.url;\r\n    if (this.ae) url = url + '/' + this.ae;\r\n    return this.doRequest({\r\n      url: url + '?rcn=5&lim=10',\r\n      method: 'GET',\r\n    }).then(response => {\r\n      if (response.status === 200) {\r\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\r\n      }\r\n    });\r\n  }\r\n\r\n  annotationQuery(options) {\r\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\r\n    var annotationQuery = {\r\n      range: options.range,\r\n      annotation: {\r\n        name: options.annotation.name,\r\n        datasource: options.annotation.datasource,\r\n        enable: options.annotation.enable,\r\n        iconColor: options.annotation.iconColor,\r\n        query: query\r\n      },\r\n      rangeRaw: options.rangeRaw\r\n    };\r\n\r\n    return this.doRequest({\r\n      url: this.url + '/annotations',\r\n      method: 'POST',\r\n      data: annotationQuery\r\n    }).then(result => {\r\n      return result.data;\r\n    });\r\n  }\r\n\r\n  metricFindQuery(query) {\r\n    var interpolated = {\r\n        target: this.templateSrv.replace(query, null, 'regex')\r\n    };\r\n\r\n    var qry = \"fu=1&ty=3\";\r\n    var url = this.url;\r\n    if (this.ae) url = url + '/' + this.ae;\r\n    var _this = this;\r\n\r\n\r\n/////////////////////////\r\n\r\n    return this.doRequest({\r\n        url: url + '?' + qry,\r\n        method: 'GET'\r\n    }).then(function (result) {\r\n        var data = result.data[\"m2m:uril\"];\r\n        console.log(\"\t>listContainers: \", data);\r\n        var arr = data.split(\" \");\r\n        return _.map(arr, function (d, i) {\r\n            if (d) {\r\n                var n = d.replace(\"/onem2m/\" + _this.ae + \"/\", \"\");\r\n                return {text: n, value: n};\r\n            }\r\n        });\r\n    });\r\n  }\r\n  \r\n  metricFindFields(query, target) {\r\n    //console.log(\"metricFindFields: \", query, target);\r\n    var _this = this;\r\n    var url = this.url;\r\n    if (this.ae)\r\n        url = url + '/' + this.ae + '/' + target.target;\r\n    return this.doRequest({\r\n        url: url + '?rcn=5&lim=1',\r\n        method: 'GET',\r\n    }).then(response => {\r\n        if (response.status === 200) {\r\n            var data = response.data[\"m2m:cin\"];\r\n            // search data columns\r\n            var cols = [];\r\n            for (var k in _this._getContent(data[0])) {\r\n                cols.push({text: k, value: k});\r\n            }\r\n            return cols;\r\n        }\r\n    });\r\n  }\r\n  \r\n  metricGetJson(target) {\r\n    //console.log(\"metricGetJson: \", target);\r\n    var url = this.url;\r\n    if (this.ae)\r\n        url = url + '/' + this.ae + '/' + target.target;\r\n    return this.doRequest({\r\n        url: url + '?rcn=5&lim=1',\r\n        method: 'GET',\r\n    }).then(response => {\r\n        if (response.status === 200) {\r\n            return response.data[\"m2m:cin\"][0].con;\r\n        } else {\r\n            return {};\r\n        }\r\n    });\r\n  }\r\n\r\n  doRequest(options) {\r\n    options.withCredentials = this.withCredentials;\r\n    options.headers = this.headers;\r\n    options.headers['X-M2M-RI'] = new Date().getTime();\r\n\r\n    return this.backendSrv.datasourceRequest(options);\r\n  }\r\n\r\n  buildQueryParameters(options) {\r\n    //remove placeholder targets\r\n    options.targets = _.filter(options.targets, target => {\r\n      return target.target !== 'select metric';\r\n    });\r\n\r\n    var targets = _.map(options.targets, target => {\r\n      return {\r\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\r\n        refId: target.refId,\r\n        hide: target.hide,\r\n        type: target.type || 'timeserie',\r\n        field: target.field || {},\r\n      };\r\n    });\r\n\r\n    options.targets = targets;\r\n\r\n    return options;\r\n  }\r\n  \r\n  \r\n    _getContent(cin) {\r\n        var con;\r\n  \tif (cin.cnf.indexOf(\"application/json\")!=-1 && typeof cin.con == 'string') {\r\n\t\ttry {\r\n                    con = JSON.parse(cin.con);\r\n\t\t} catch(e) {\r\n                    console.warn(\"json.parse: error=\",e.name,\"con=\",cin.con);\r\n                    con = {};\r\n\t\t}\r\n\t} else {\r\n            con = {};\r\n\t}\r\n        return con;\r\n    }\r\n  \r\n    _utc2date(utc_str) {\r\n        var d = moment.utc(utc_str).toDate();\r\n        return d;\r\n    }\r\n    \r\n    _respTable(data) {\r\n        var out = [{\"columns\": [], \"rows\": [], \"type\": \"table\"}];\r\n        // timestamp\r\n        out[0].columns.push({\r\n            \"text\": \"Time\",\r\n            \"type\": \"time\",\r\n            \"sort\": true,\r\n            \"desc\": true,\r\n        });\r\n        // search data columns\r\n        var cols = [];\r\n        for (var k in this._getContent(data[0])) {\r\n            out[0].columns.push({\r\n                \"text\": k,\r\n            });\r\n            cols.push(k);\r\n        }\r\n        // create table data format\r\n        for (var k in data) {\r\n            var row = [];\r\n            // convert ct UTC date to ts\r\n            row.push(this._utc2date(data[k].ct).getTime());\r\n            for (var i in cols) {\r\n                var prop = cols[i];\r\n                var con = this._getContent(data[k]);\r\n                row.push(con[prop]);\r\n            }\r\n            out[0].rows.push(row);\r\n        }\r\n        console.log(\"tabled: \", out);\r\n        return out;\r\n    }\r\n\r\n    _respTimeserie(data, field) {\r\n        var out = [{\"target\": null, \"datapoints\": []}];\r\n        if (field && field.path) {\r\n            out[0].target = field.name || field.path;\r\n            for (var k in data) {\r\n                var props = this._getContent(data[k]);\r\n                var value = _.get(props, field.path);    // lodash _.get(object, path, [defaultValue])\r\n                out[0].datapoints.push([\r\n                    value,\r\n                    this._utc2date(data[k].ct).getTime()\t// convert ct UTC date to ts\r\n                ]);\r\n            }\r\n        } else {\r\n            out = [];\r\n            // search data columns\r\n            for (var field in this._getContent(data[0])) {\r\n                console.log(\">: \", field);\r\n                var dp = [];\r\n                for (var k in data) {\r\n                    var props = this._getContent(data[k]);\r\n                    dp.push([\r\n                        props[field],\r\n                        this._utc2date(data[k].ct).getTime()\t// convert ct UTC date to ts\r\n                    ]);\r\n                }\r\n                out.push({\"target\": field, \"datapoints\": dp});\r\n            }\r\n        }\r\n        console.log(\"timeserie: \", out);\r\n        return out;\r\n    }\r\n\r\n}\r\n"]}